version: "3.8"

services:
  # 1. Frontend (Vite)
  client:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - ./apps/web:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:5000
      - VITE_WS_URL=ws://localhost:5000
    depends_on:
      - server

  # 2. Main Server (Socket.IO + API Gateway)
  server:
    build:
      context: ./apps/server
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    volumes:
      - ./apps/server:/app
      - /app/node_modules
    environment:
      - PORT=5000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ORCHESTRATOR_URL=http://orchestrator:4000
      - CLIENT_URL=http://localhost:5173
      - JWT_SECRET=dev-secret-change-in-production
    depends_on:
      - redis
      - orchestrator

  # 3. Orchestrator (Job Queue Manager)
  orchestrator:
    build:
      context: ./apps/orchestrator
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    volumes:
      - ./apps/orchestrator:/app
      - /app/node_modules
    environment:
      - PORT=4000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis

  # 4. Redis (Message Bus & Queue)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  # 5. Runner Worker (Executes Code - Sandboxed)
  runner:
    build:
      context: ./apps/runner
      dockerfile: Dockerfile
    volumes:
      - /tmp/code-exec:/tmp/code-exec
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    # Security: container sandboxing
    read_only: true
    tmpfs:
      - /tmp:size=100M
      - /app/codes:size=50M
      - /app/output:size=50M
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    mem_limit: 512m
    cpus: 1.0
    pids_limit: 64
    security_opt:
      - no-new-privileges:true

volumes:
  redis-data:
